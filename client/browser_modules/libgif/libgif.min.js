!function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():e.SuperGif=t()}(this,function(){var e=function(e){return e.reduce(function(e,t){return 2*e+t},0)},t=function(e){for(var t=[],n=7;n>=0;n--)t.push(!!(e&1<<n));return t},n=function(e){this.data=e,this.len=this.data.length,this.pos=0,this.readByte=function(){if(this.pos>=this.data.length)throw new Error("Attempted to read past end of stream.");return e instanceof Uint8Array?e[this.pos++]:255&e.charCodeAt(this.pos++)},this.readBytes=function(e){for(var t=[],n=0;n<e;n++)t.push(this.readByte());return t},this.read=function(e){for(var t="",n=0;n<e;n++)t+=String.fromCharCode(this.readByte());return t},this.readUnsigned=function(){var e=this.readBytes(2);return(e[1]<<8)+e[0]}},r=function(e,t){for(var n,r,i=0,a=[],o=1<<e,l=o+1,s=e+1,c=[];;)if(r=n,(n=function(e){for(var n=0,r=0;r<e;r++)t.charCodeAt(i>>3)&1<<(7&i)&&(n|=1<<r),i++;return n}(s))!==o){if(n===l)break;if(n<c.length)r!==o&&c.push(c[r].concat(c[n][0]));else{if(n!==c.length)throw new Error("Invalid LZW code.");c.push(c[r].concat(c[r][0]))}a.push.apply(a,c[n]),c.length===1<<s&&s<12&&s++}else!function(){c=[],s=e+1;for(var t=0;t<o;t++)c[t]=[t];c[o]=[],c[l]=null}();return a},i=function(n,i){i||(i={});var a=function(e){for(var t=[],r=0;r<e;r++)t.push(n.readBytes(3));return t},o=function(){var e,t;t="";do{e=n.readByte(),t+=n.read(e)}while(0!==e);return t},l=function(r){switch(r.label=n.readByte(),r.label){case 249:r.extType="gce",function(r){n.readByte();var a=t(n.readByte());r.reserved=a.splice(0,3),r.disposalMethod=e(a.splice(0,3)),r.userInput=a.shift(),r.transparencyGiven=a.shift(),r.delayTime=n.readUnsigned(),r.transparencyIndex=n.readByte(),r.terminator=n.readByte(),i.gce&&i.gce(r)}(r);break;case 254:r.extType="com",function(e){e.comment=o(),i.com&&i.com(e)}(r);break;case 1:r.extType="pte",function(e){n.readByte();e.ptHeader=n.readBytes(12),e.ptData=o(),i.pte&&i.pte(e)}(r);break;case 255:r.extType="app",function(e){n.readByte();switch(e.identifier=n.read(8),e.authCode=n.read(3),e.identifier){case"NETSCAPE":!function(e){n.readByte();e.unknown=n.readByte(),e.iterations=n.readUnsigned(),e.terminator=n.readByte(),i.app&&i.app.NETSCAPE&&i.app.NETSCAPE(e)}(e);break;default:!function(e){e.appData=o(),i.app&&i.app[e.identifier]&&i.app[e.identifier](e)}(e)}}(r);break;default:r.extType="unknown",function(e){e.data=o(),i.unknown&&i.unknown(e)}(r)}},s=function(l){l.leftPos=n.readUnsigned(),l.topPos=n.readUnsigned(),l.width=n.readUnsigned(),l.height=n.readUnsigned();var s=t(n.readByte());l.lctFlag=s.shift(),l.interlaced=s.shift(),l.sorted=s.shift(),l.reserved=s.splice(0,2),l.lctSize=e(s.splice(0,3)),l.lctFlag&&(l.lct=a(1<<l.lctSize+1)),l.lzwMinCodeSize=n.readByte();var c=o();l.pixels=r(l.lzwMinCodeSize,c),l.interlaced&&(l.pixels=function(e,t){for(var n=new Array(e.length),r=e.length/t,i=[0,4,2,1],a=[8,8,4,2],o=0,l=0;l<4;l++)for(var s=i[l];s<r;s+=a[l])!function(r,i){var a=e.slice(i*t,(i+1)*t);n.splice.apply(n,[r*t,t].concat(a))}(s,o),o++;return n}(l.pixels,l.width)),i.img&&i.img(l)},c=function(){var e={};switch(e.sentinel=n.readByte(),String.fromCharCode(e.sentinel)){case"!":e.type="ext",l(e);break;case",":e.type="img",s(e);break;case";":e.type="eof",i.eof&&i.eof(e);break;default:throw new Error("Unknown block: 0x"+e.sentinel.toString(16))}"eof"!==e.type&&setTimeout(c,0)};(function(){var r={};if(r.sig=n.read(3),r.ver=n.read(3),"GIF"!==r.sig)throw new Error("Not a GIF file.");r.width=n.readUnsigned(),r.height=n.readUnsigned();var o=t(n.readByte());r.gctFlag=o.shift(),r.colorRes=e(o.splice(0,3)),r.sorted=o.shift(),r.gctSize=e(o.splice(0,3)),r.bgColor=n.readByte(),r.pixelAspectRatio=n.readByte(),r.gctFlag&&(r.gct=a(1<<r.gctSize+1)),i.hdr&&i.hdr(r)})(),setTimeout(c,0)};return function(e){var t={vp_l:0,vp_t:0,vp_w:null,vp_h:null,c_w:null,c_h:null};for(var r in e)t[r]=e[r];t.vp_w&&t.vp_h&&(t.is_vp=!0);var a,o,l=null,s=!1,c=null,u=null,d=null,h=null,p=null,f=null,g=null,_=!0,y=!1,w=[],v=[],m=t.gif;void 0===t.auto_play&&(t.auto_play=!m.getAttribute("rel:auto_play")||"1"==m.getAttribute("rel:auto_play"));var x,b,T,B,C=t.hasOwnProperty("on_end")?t.on_end:null,P=t.hasOwnProperty("loop_delay")?t.loop_delay:0,k=t.hasOwnProperty("loop_mode")?t.loop_mode:"auto",S=!t.hasOwnProperty("draw_while_loading")||t.draw_while_loading,A=!!S&&(!t.hasOwnProperty("show_progress_bar")||t.show_progress_bar),E=t.hasOwnProperty("progressbar_height")?t.progressbar_height:25,I=t.hasOwnProperty("progressbar_background_color")?t.progressbar_background_color:"rgba(255,255,255,0.4)",U=t.hasOwnProperty("progressbar_foreground_color")?t.progressbar_foreground_color:"rgba(255,0,22,.8)",O=function(){c=null,u=null,p=d,d=null,f=null},R=function(){try{i(a,H)}catch(e){D("parse")}},z=function(e,t){x.width=e*L(),x.height=t*L(),T.style.minWidth=e*L()+"px",B.width=e,B.height=t,B.style.width=e+"px",B.style.height=t+"px",B.getContext("2d").setTransform(1,0,0,1,0,0)},N=function(e,n,r){if(r&&A){var i,a,o,l=E;if(t.is_vp){y?(a=(t.vp_t+t.vp_h-l)/L(),l/=L(),i=t.vp_l/L()+e/n*(t.vp_w/L()),o=x.width/L()):(a=t.vp_t+t.vp_h-l,l=l,i=t.vp_l+e/n*t.vp_w,o=x.width)}else a=(x.height-l)/(y?L():1),i=e/n*x.width/(y?L():1),o=x.width/(y?L():1),l/=y?L():1;b.fillStyle=I,b.fillRect(i,a,o-i,l),b.fillStyle=U,b.fillRect(0,a,i,l)}},D=function(e){l=e,o={width:m.width,height:m.height},w=[],b.fillStyle="black",b.fillRect(0,0,t.c_w?t.c_w:o.width,t.c_h?t.c_h:o.height),b.strokeStyle="red",b.lineWidth=3,b.moveTo(0,0),b.lineTo(t.c_w?t.c_w:o.width,t.c_h?t.c_h:o.height),b.moveTo(0,t.c_h?t.c_h:o.height),b.lineTo(t.c_w?t.c_w:o.width,0),b.stroke()},F=function(){f&&(w.push({data:f.getImageData(0,0,o.width,o.height),delay:u}),v.push({x:0,y:0}))},M=function(){var e=-1,n=0,r=function(){return(e+1+w.length)%w.length},i=function(t){e+=t,o()},a=function(){var t=!1,a=function(){null!==C&&C(m),n++,!1!==k||n<0?o():(t=!1,_=!1)},o=function(){if(t=_){i(1);var n=10*w[e].delay;n||(n=100),0===r()?(n+=P,setTimeout(a,n)):setTimeout(o,n)}};return function(){t||setTimeout(o,0)}}(),o=function(){var t;(e=parseInt(e,10))>w.length-1&&(e=0),e<0&&(e=0),t=v[e],B.getContext("2d").putImageData(w[e].data,t.x,t.y),b.globalCompositeOperation="copy",b.drawImage(B,0,0)};return{init:function(){l||(t.c_w&&t.c_h||b.scale(L(),L()),t.auto_play?a():(e=0,o()))},step:a,play:function(){_=!0,a()},pause:function(){_=!1},playing:_,move_relative:i,current_frame:function(){return e},length:function(){return w.length},move_to:function(t){e=t,o()}}}(),G=function(e){N(a.pos,a.data.length,e)},j=function(){},W=function(e,t){return function(n){e(n),G(t)}},H={hdr:W(function(e){z((o=e).width,o.height)}),gce:W(function(e){F(),O(),c=e.transparencyGiven?e.transparencyIndex:null,u=e.delayTime,d=e.disposalMethod}),com:W(j),app:{NETSCAPE:W(j)},img:W(function(e){f||(f=B.getContext("2d"));var n=w.length,r=e.lctFlag?e.lct:o.gct;n>0&&(3===p?null!==h?f.putImageData(w[h].data,0,0):f.clearRect(g.leftPos,g.topPos,g.width,g.height):h=n-1,2===p&&f.clearRect(g.leftPos,g.topPos,g.width,g.height));var i=f.getImageData(e.leftPos,e.topPos,e.width,e.height);e.pixels.forEach(function(e,t){e!==c&&(i.data[4*t+0]=r[e][0],i.data[4*t+1]=r[e][1],i.data[4*t+2]=r[e][2],i.data[4*t+3]=255)}),f.putImageData(i,e.leftPos,e.topPos),y||(b.scale(L(),L()),y=!0),S&&(b.drawImage(B,0,0),S=t.auto_play),g=e},!0),eof:function(e){F(),G(!1),t.c_w&&t.c_h||(x.width=o.width*L(),x.height=o.height*L()),M.init(),s=!1,X&&X(m)}},q=function(){var e=m.parentNode,n=document.createElement("div");x=document.createElement("canvas"),b=x.getContext("2d"),T=document.createElement("div"),B=document.createElement("canvas"),n.width=x.width=m.width,n.height=x.height=m.height,T.style.minWidth=m.width+"px",n.className="jsgif",T.className="jsgif_toolbar",n.appendChild(x),n.appendChild(T),e.insertBefore(n,m),e.removeChild(m),t.c_w&&t.c_h&&z(t.c_w,t.c_h),V=!0},L=function(){return t.max_width&&o&&o.width>t.max_width?t.max_width/o.width:1},V=!1,X=!1,Z=function(e){return!s&&(X=e||!1,s=!0,w=[],O(),h=null,p=null,f=null,g=null,!0)};return{play:M.play,pause:M.pause,move_relative:M.move_relative,move_to:M.move_to,get_playing:function(){return _},get_canvas:function(){return x},get_canvas_scale:function(){return L()},get_loading:function(){return s},get_auto_play:function(){return t.auto_play},get_length:function(){return M.length()},get_current_frame:function(){return M.current_frame()},load_url:function(e,t){if(Z(t)){var r=new XMLHttpRequest;r.open("GET",e,!0),"overrideMimeType"in r?r.overrideMimeType("text/plain; charset=x-user-defined"):"responseType"in r?r.responseType="arraybuffer":r.setRequestHeader("Accept-Charset","x-user-defined"),r.onloadstart=function(){V||q()},r.onload=function(e){200!=this.status&&D("xhr - response"),"response"in this||(this.response=new VBArray(this.responseText).toArray().map(String.fromCharCode).join(""));var t=this.response;t.toString().indexOf("ArrayBuffer")>0&&(t=new Uint8Array(t)),a=new n(t),setTimeout(R,0)},r.onprogress=function(e){e.lengthComputable&&N(e.loaded,e.total,!0)},r.onerror=function(){D("xhr")},r.send()}},load:function(e){this.load_url(m.getAttribute("rel:animated_src")||m.src,e)},load_raw:function(e,t){Z(t)&&(V||q(),a=new n(e),setTimeout(R,0))},set_frame_offset:function(e,t){v[e]?(void 0!==t.x&&(v[e].x=t.x),void 0!==t.y&&(v[e].y=t.y)):v[e]=t}}}});